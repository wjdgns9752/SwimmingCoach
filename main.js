// --- Translations ---
const TRANSLATIONS = {
  ko: {
    appTitle: "Ïä§ÏúÑÎ∞çÏΩîÏπò",
    navDashboard: "ÎåÄÏãúÎ≥¥Îìú", navLogger: "ÌõàÎ†® ÏùºÏßÄ", navAnalysis: "AI Î∂ÑÏÑù", navClub: "ÌÅ¥ÎüΩ", navProfile: "ÎÇ¥ Í∏∞Î°ù",
    greeting: "Ïò§ÎäòÎèÑ Î¨ºÏÇ¥ÏùÑ Í∞ÄÎ•º Ï§ÄÎπÑ ÎêòÏÖ®ÎÇòÏöî?",
    dailyPlanTitle: "Ïò§ÎäòÏùò ÎßûÏ∂§ ÌõàÎ†®",
    termHint: "ÌõàÎ†® Ïö©Ïñ¥ ÏÑ§Î™Ö Î≥¥Í∏∞",
    tapDetails: "ÌÑ∞ÏπòÌïòÏó¨ ÏÉÅÏÑ∏ Í∞ÄÏù¥Îìú ‚Üí",
    weeklyDistTitle: "Ïù¥Î≤à Ï£º ÎàÑÏ†Å Í±∞Î¶¨",
    recentCompTitle: "ÏµúÍ∑º ÎåÄÌöå Í∏∞Î°ù",
    btnAddRecord: "Í∏∞Î°ù Ï∂îÍ∞ÄÌïòÍ∏∞",
    loggerTitle: "ÌõàÎ†® ÏùºÏßÄ ÏûëÏÑ±",
    dateLabel: "üìÖ ÎÇ†Ïßú Î∞è ÏãúÍ∞Ñ",
    distLabel: "üèä ÏàòÏòÅ Í±∞Î¶¨",
    btnSave: "Í∏∞Î°ù Ï†ÄÏû•ÌïòÍ∏∞",
    profileTitle: "ÎÇ¥ Ï†ïÎ≥¥ Í¥ÄÎ¶¨",
    profileHeader: "üë§ ÌîÑÎ°úÌïÑ Î∞è Ïã†Ï≤¥ Ï†ïÎ≥¥",
    labelNickname: "ÎãâÎÑ§ÏûÑ", labelAge: "ÎÇòÏù¥", labelGender: "ÏÑ±Î≥Ñ", labelLevel: "ÏàòÏòÅ Î†àÎ≤®", labelGoal: "ÌõàÎ†® Î™©Ìëú",
    genderMale: "ÎÇ®ÏÑ±", genderFemale: "Ïó¨ÏÑ±",
    goalEndurance: "ÏßÄÍµ¨Î†•", goalSpeed: "Ïä§ÌîºÎìú", goalTechnique: "ÏûêÏÑ∏ ÍµêÏ†ï", goalDiet: "Îã§Ïù¥Ïñ¥Ìä∏", goalComp: "ÎåÄÌöå Ï§ÄÎπÑ",
    recordsHeader: "üèä‚Äç‚ôÇÔ∏è Í∏∞Ï§Ä Í∏∞Î°ù (50m)",
    btnUpdate: "Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•",
    uploadTitle: "ÎèôÏòÅÏÉÅ ÏóÖÎ°úÎìú",
    termTitle: "ÌõàÎ†® Ïö©Ïñ¥ Í∞ÄÏù¥Îìú",
    descEN1: "Í∏∞Ï¥à ÏßÄÍµ¨Î†•. Ìé∏ÏïàÌïú Ìò∏Ìù° (ÏµúÎåÄÏã¨Î∞ï 60-70%)",
    descEN2: "Ïú†ÏÇ∞ÏÜå Ïó≠Ïπò. ÏßÄÏÜç Í∞ÄÎä•ÌïòÏßÄÎßå ÏïΩÍ∞Ñ Ïà®Ï∞∏ (ÏµúÎåÄÏã¨Î∞ï 70-80%)",
    descEN3: "ÏµúÎåÄ ÏÇ∞ÏÜå ÏÑ≠Ï∑®Îüâ. Ïà®Ïù¥ ÎßéÏù¥ Ï∞∏ (ÏµúÎåÄÏã¨Î∞ï 80-90%)",
    descSP1: "Ï†ñÏÇ∞ ÎÇ¥ÏÑ±. ÏµúÍ≥† ÏÜçÎèÑ, ÏßßÏùÄ Ìú¥Ïãù",
    descDrill: "ÏûêÏÑ∏ ÍµêÏ†ïÏùÑ ÏúÑÌïú Î∂ÄÎ∂Ñ ÎèôÏûë Ïó∞Ïäµ"
  },
  en: {
    appTitle: "SwimCoach",
    navDashboard: "Dashboard", navLogger: "Log", navAnalysis: "AI Analysis", navClub: "Club", navProfile: "Profile",
    greeting: "Ready to hit the water?",
    dailyPlanTitle: "Daily Workout Plan",
    termHint: "View Terminology Guide",
    tapDetails: "Tap for details ‚Üí",
    weeklyDistTitle: "Weekly Distance",
    recentCompTitle: "Recent Best",
    btnAddRecord: "Add Record",
    loggerTitle: "Workout Log",
    dateLabel: "üìÖ Date & Time",
    distLabel: "üèä Distance",
    btnSave: "Save Log",
    profileTitle: "Edit Profile",
    profileHeader: "üë§ Personal Info",
    labelNickname: "Nickname", labelAge: "Age", labelGender: "Gender", labelLevel: "Level", labelGoal: "Goal",
    genderMale: "Male", genderFemale: "Female",
    goalEndurance: "Endurance", goalSpeed: "Speed", goalTechnique: "Technique", goalDiet: "Fitness/Diet", goalComp: "Competition",
    recordsHeader: "üèä‚Äç‚ôÇÔ∏è Personal Best (50m)",
    btnUpdate: "Save Changes",
    uploadTitle: "Upload Video",
    termTitle: "Training Terminology",
    descEN1: "Basic Endurance. Comfortable breathing (HR 60-70%)",
    descEN2: "Aerobic Threshold. Sustainable but breathless (HR 70-80%)",
    descEN3: "VO2 Max. Hard breathing (HR 80-90%)",
    descSP1: "Lactate Tolerance. Max speed, short rest",
    descDrill: "Drills for technique correction"
  },
  jp: {
    appTitle: "„Çπ„Ç§„Éü„É≥„Ç∞„Ç≥„Éº„ÉÅ",
    navDashboard: "„Éõ„Éº„É†", navLogger: "Êó•Ë™å", navAnalysis: "AIÂàÜÊûê", navClub: "„ÇØ„É©„Éñ", navProfile: "Ë®òÈå≤",
    greeting: "‰ªäÊó•„ÇÇÊ≥≥„ÅêÊ∫ñÂÇô„ÅØ„Åß„Åç„Åæ„Åó„Åü„ÅãÔºü",
    dailyPlanTitle: "‰ªäÊó•„ÅÆ„É°„Éã„É•„Éº",
    termHint: "Áî®Ë™û„Ç¨„Ç§„Éâ„ÇíË¶ã„Çã",
    tapDetails: "„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„Å∏ ‚Üí",
    weeklyDistTitle: "‰ªäÈÄ±„ÅÆË∑ùÈõ¢",
    recentCompTitle: "ÊúÄËøë„ÅÆË®òÈå≤",
    btnAddRecord: "Ë®òÈå≤„ÇíËøΩÂä†",
    loggerTitle: "„Éà„É¨„Éº„Éã„É≥„Ç∞Êó•Ë™å",
    dateLabel: "üìÖ Êó•ÊôÇ",
    distLabel: "üèä Ë∑ùÈõ¢",
    btnSave: "‰øùÂ≠ò„Åô„Çã",
    profileTitle: "„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ",
    profileHeader: "üë§ Âü∫Êú¨ÊÉÖÂ†±",
    labelNickname: "„Éã„ÉÉ„ÇØ„Éç„Éº„É†", labelAge: "Âπ¥ÈΩ¢", labelGender: "ÊÄßÂà•", labelLevel: "„É¨„Éô„É´", labelGoal: "ÁõÆÊ®ô",
    genderMale: "Áî∑ÊÄß", genderFemale: "Â•≥ÊÄß",
    goalEndurance: "ÊåÅ‰πÖÂäõ", goalSpeed: "„Çπ„Éî„Éº„Éâ", goalTechnique: "„Éï„Ç©„Éº„É†ÁüØÊ≠£", goalDiet: "„ÉÄ„Ç§„Ç®„ÉÉ„Éà", goalComp: "Â§ß‰ºö",
    recordsHeader: "üèä‚Äç‚ôÇÔ∏è Ëá™Â∑±„Éô„Çπ„Éà (50m)",
    btnUpdate: "Â§âÊõ¥„Çí‰øùÂ≠ò",
    uploadTitle: "ÂãïÁîª„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
    termTitle: "„Éà„É¨„Éº„Éã„É≥„Ç∞Áî®Ë™û",
    descEN1: "Âü∫Á§éÊåÅ‰πÖÂäõ„ÄÇÊ•Ω„Å™ÂëºÂê∏ (ÂøÉÊãçÊï∞ 60-70%)",
    descEN2: "ÊúâÈÖ∏Á¥†ÈñæÂÄ§„ÄÇ„ÇÑ„ÇÑ„Åç„Å§„ÅÑ (ÂøÉÊãçÊï∞ 70-80%)",
    descEN3: "ÊúÄÂ§ßÈÖ∏Á¥†ÊëÇÂèñÈáè„ÄÇ„Åã„Å™„Çä„Åç„Å§„ÅÑ (ÂøÉÊãçÊï∞ 80-90%)",
    descSP1: "‰π≥ÈÖ∏ËÄêÊÄß„ÄÇÂÖ®Âäõ„ÉÄ„ÉÉ„Ç∑„É•",
    descDrill: "„Éï„Ç©„Éº„É†ÁüØÊ≠£Á∑¥Áøí"
  },
  cn: {
    appTitle: "Ê∏∏Ê≥≥ÊïôÁªÉ",
    navDashboard: "‰ª™Ë°®Áõò", navLogger: "Êó•Âøó", navAnalysis: "AIÂàÜÊûê", navClub: "‰ø±‰πêÈÉ®", navProfile: "ËÆ∞ÂΩï",
    greeting: "ÂáÜÂ§áÂ•ΩÊ∏∏Ê≥≥‰∫ÜÂêóÔºü",
    dailyPlanTitle: "‰ªäÊó•ËÆ≠ÁªÉËÆ°Âàí",
    termHint: "Êü•ÁúãÊúØËØ≠ÊåáÂçó",
    tapDetails: "ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ ‚Üí",
    weeklyDistTitle: "Êú¨Âë®Ë∑ùÁ¶ª",
    recentCompTitle: "ËøëÊúüËÆ∞ÂΩï",
    btnAddRecord: "Ê∑ªÂä†ËÆ∞ÂΩï",
    loggerTitle: "ËÆ≠ÁªÉÊó•Âøó",
    dateLabel: "üìÖ Êó•ÊúüÂíåÊó∂Èó¥",
    distLabel: "üèä Ë∑ùÁ¶ª",
    btnSave: "‰øùÂ≠ò",
    profileTitle: "ÁºñËæë‰∏™‰∫∫ËµÑÊñô",
    profileHeader: "üë§ ‰∏™‰∫∫‰ø°ÊÅØ",
    labelNickname: "ÊòµÁß∞", labelAge: "Âπ¥ÈæÑ", labelGender: "ÊÄßÂà´", labelLevel: "Á≠âÁ∫ß", labelGoal: "ÁõÆÊ†á",
    genderMale: "Áî∑", genderFemale: "Â•≥",
    goalEndurance: "ËÄêÂäõ", goalSpeed: "ÈÄüÂ∫¶", goalTechnique: "ÊäÄÊúØ", goalDiet: "ÂáèËÇ•", goalComp: "ÊØîËµõ",
    recordsHeader: "üèä‚Äç‚ôÇÔ∏è ‰∏™‰∫∫ÊúÄÂ•ΩÊàêÁª© (50m)",
    btnUpdate: "‰øùÂ≠òÊõ¥Êîπ",
    uploadTitle: "‰∏ä‰º†ËßÜÈ¢ë",
    termTitle: "ËÆ≠ÁªÉÊúØËØ≠",
    descEN1: "Âü∫Á°ÄËÄêÂäõ„ÄÇÂëºÂê∏ËΩªÊùæ (ÂøÉÁéá 60-70%)",
    descEN2: "ÊúâÊ∞ßÈòàÂÄº„ÄÇÁ®çÂñò (ÂøÉÁéá 70-80%)",
    descEN3: "ÊúÄÂ§ßÊëÑÊ∞ßÈáè„ÄÇÂæàÂñò (ÂøÉÁéá 80-90%)",
    descSP1: "‰π≥ÈÖ∏ËÄêÂèó„ÄÇÂÖ®ÂäõÂÜ≤Âà∫",
    descDrill: "ÊäÄÊúØÂàÜËß£ÁªÉ‰π†"
  }
};

let currentLang = 'ko';

function setLanguage(lang) {
    if (!TRANSLATIONS[lang]) return;
    currentLang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (TRANSLATIONS[lang][key]) {
            el.textContent = TRANSLATIONS[lang][key];
        }
    });
    // Re-generate plan to update text inside it
    const profile = JSON.parse(localStorage.getItem(PROFILE_KEY));
    if(profile) generateDailyPlan(profile.level, profile.goal, profile);
}

// --- App Logic ---

console.log('App Initializing...');

// Constants
const PROFILE_KEY = 'swim_user_profile';
const WORKOUT_KEY = 'swim_workouts';
const RECORDS_KEY = 'swim_competition_records';
const CLUB_KEY = 'swim_user_club';
const CUSTOM_CLUBS_KEY = 'swim_custom_clubs';

// Init
document.addEventListener('DOMContentLoaded', () => {
    initNavigation();
    initLanguage();
    
    // Load Profile & Plan
    let profile = JSON.parse(localStorage.getItem(PROFILE_KEY));
    if (!profile) {
        // Default dummy profile if none exists
        profile = { nickname: 'Swimmer', level: 'intermediate', goal: 'endurance', age: 25, gender: 'm' };
    }
    applyUserProfile(profile);
    
    loadWorkouts();
    loadRecords();
    initClubFeature();
    initAnalysisControls();
    
    // Inputs Init
    const dateInput = document.getElementById('date');
    if(dateInput) dateInput.valueAsDate = new Date();
});

function initLanguage() {
    const sel = document.getElementById('language-selector');
    if(!sel) return;
    sel.addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });
}

// Navigation
function initNavigation() {
    const navLinks = document.querySelectorAll('.nav-link, .nav-item');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.closest('[data-page]');
            if (target && target.dataset.page) navigateTo(target.dataset.page);
        });
    });
}

window.navigateTo = function(pageId) {
    const sections = document.querySelectorAll('.page-section');
    sections.forEach(sec => {
        if (sec.id === `${pageId}-page`) {
            sec.classList.remove('hidden');
            sec.classList.add('active');
        } else {
            sec.classList.add('hidden');
            sec.classList.remove('active');
        }
    });

    // Update Nav Active State
    document.querySelectorAll('.nav-link, .nav-item').forEach(item => {
        if (item.dataset.page === pageId) item.classList.add('active');
        else item.classList.remove('active');
    });
    window.scrollTo(0,0);
};

// --- Profile & Logic ---

function applyUserProfile(profile) {
    if (!profile) return;
    
    // Greeting
    const greeting = document.getElementById('user-greeting');
    if(greeting) greeting.textContent = currentLang === 'ko' ? `${profile.nickname}Îãò, Ïò§ÎäòÎèÑ ÌååÏù¥ÌåÖ!` : `Welcome back, ${profile.nickname}!`;

    // Fill Form
    if(document.getElementById('profile-nickname')) document.getElementById('profile-nickname').value = profile.nickname || '';
    if(document.getElementById('profile-age')) document.getElementById('profile-age').value = profile.age || '';
    if(document.getElementById('profile-gender')) document.getElementById('profile-gender').value = profile.gender || 'm';
    if(document.getElementById('profile-level')) document.getElementById('profile-level').value = profile.level || 'intermediate';
    if(document.getElementById('profile-goal')) document.getElementById('profile-goal').value = profile.goal || 'endurance';
    if(document.getElementById('record-free')) document.getElementById('record-free').value = profile.recFree || '';
    if(document.getElementById('record-breast')) document.getElementById('record-breast').value = profile.recBreast || '';

    updateLevelBadge(profile.level);
    generateDailyPlan(profile.level, profile.goal, profile);
}

window.saveProfileChanges = function() {
    const nickname = document.getElementById('profile-nickname').value;
    const age = document.getElementById('profile-age').value;
    const gender = document.getElementById('profile-gender').value;
    const level = document.getElementById('profile-level').value;
    const goal = document.getElementById('profile-goal').value;
    const recFree = document.getElementById('record-free').value;
    const recBreast = document.getElementById('record-breast').value;

    const profile = { nickname, age, gender, level, goal, recFree, recBreast };
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    
    applyUserProfile(profile);
    alert(currentLang === 'ko' ? 'Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.' : 'Saved!');
};

function updateLevelBadge(level) {
    const badge = document.getElementById('user-level-badge');
    if(badge) badge.textContent = level.toUpperCase();
}

// --- GENERATOR LOGIC (Enhanced) ---
let currentDailyPlan = null;

function generateDailyPlan(level, goal, profile) {
    const planText = document.getElementById('daily-plan-text');
    if (!planText) return;

    // Logic based on Age/Gender/Records
    let baseDist = 1500;
    if (level === 'beginner') baseDist = 800;
    if (level === 'advanced') baseDist = 2500;
    if (level === 'masters') baseDist = 3200;
    if (level === 'elite') baseDist = 4500;

    // Age Factor: Reduce volume slightly for seniors if not elite
    if (profile.age && profile.age > 50 && level !== 'elite') baseDist *= 0.8;
    
    let plan = { title: "Generic Plan", desc: "General swim", warmup: [], drill: [], main: [], cooldown: [] };
    
    // Helper to format
    const distStr = (d) => `${Math.floor(d)}m`;

    if (goal === 'speed') {
        plan.title = "Sprint & Power (SP1/SP2)";
        plan.desc = "Focus on lactate tolerance.";
        plan.warmup = [{dist: distStr(baseDist*0.2), desc: "Choice swim (EN1)"}];
        plan.drill = [{dist: distStr(baseDist*0.1), desc: "Sculling & Catch (Drill)"}];
        plan.main = [
            {dist: distStr(baseDist*0.1), desc: "4x25m Sprint (SP1) @ 1:30"},
            {dist: distStr(baseDist*0.4), desc: "Broken Swim 50m (SP2)"}
        ];
        plan.cooldown = [{dist: distStr(baseDist*0.2), desc: "Easy Loosen (EN1)"}];
    } else if (goal === 'endurance') {
        plan.title = "Aerobic Capacity (EN1/EN2)";
        plan.desc = "Building aerobic base.";
        baseDist *= 1.1; // More volume
        plan.warmup = [{dist: distStr(baseDist*0.15), desc: "Free/Back Mix (EN1)"}];
        plan.drill = [{dist: distStr(baseDist*0.05), desc: "Fist Swim (Drill)"}];
        plan.main = [
            {dist: distStr(baseDist*0.6), desc: "Continuous Swim (EN2) HR 130-150"}
        ];
        plan.cooldown = [{dist: distStr(baseDist*0.2), desc: "Easy (EN1)"}];
    } else {
        // Default
        plan.title = "Balanced Swim (Mix)";
        plan.desc = "Technique and moderate aerobic work.";
        plan.warmup = [{dist: distStr(baseDist*0.2), desc: "Choice (EN1)"}];
        plan.drill = [{dist: distStr(baseDist*0.2), desc: "Side kick / 6-kick switch (Drill)"}];
        plan.main = [{dist: distStr(baseDist*0.4), desc: "50m x 8 (EN2) Interval"}];
        plan.cooldown = [{dist: distStr(baseDist*0.2), desc: "Easy (EN1)"}];
    }

    currentDailyPlan = plan;
    planText.innerHTML = `<strong>${plan.title}</strong><br><span style="font-size:0.9rem; color:#718096">${plan.desc}</span>`;
}

// --- Terminology Modal ---
window.openTerminologyModal = () => document.getElementById('term-modal').classList.remove('hidden');
window.closeTermModal = () => document.getElementById('term-modal').classList.add('hidden');

// --- Logger Feature ---
function loadWorkouts() {
    const list = document.getElementById('recent-activity-list');
    const distDisplay = document.getElementById('total-distance-display');
    const workouts = JSON.parse(localStorage.getItem(WORKOUT_KEY)) || [];
    
    if(list) {
        list.innerHTML = workouts.length ? '' : '<li class="empty-state">No Data</li>';
        workouts.slice(-3).reverse().forEach(w => {
            list.innerHTML += `<li><span>${w.date}</span><strong>${w.distance}m</strong></li>`;
        });
    }
    if(distDisplay) {
        const total = workouts.reduce((s,w)=>s+parseInt(w.distance||0),0);
        distDisplay.textContent = `${total}m`;
    }
}
window.addDistance = (amount) => { const el = document.getElementById('distance'); if(el) el.value = (parseInt(el.value)||0)+amount; };

const workoutForm = document.getElementById('swim-log-form');
if(workoutForm) {
    workoutForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const date = document.getElementById('date').value;
        const distance = document.getElementById('distance').value;
        const duration = document.getElementById('duration').value;
        // const notes = document.getElementById('notes').value; // Removed in simplified view, can add back if needed
        const mood = document.querySelector('input[name="mood"]:checked')?.value || 'soso';
        if (!date || !distance) return;
        const newWorkout = { date, distance, duration, mood, id: Date.now() };
        const workouts = JSON.parse(localStorage.getItem(WORKOUT_KEY)) || [];
        workouts.push(newWorkout);
        localStorage.setItem(WORKOUT_KEY, JSON.stringify(workouts));
        loadWorkouts();
        alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        navigateTo('dashboard');
    });
}

// --- Competition Records ---
const compForm = document.getElementById('competition-form');
const recordsList = document.getElementById('records-list');
const prDisplay = document.getElementById('pr-display');

function loadRecords() {
    const records = JSON.parse(localStorage.getItem(RECORDS_KEY)) || [];
    records.sort((a, b) => new Date(b.date) - new Date(a.date));
    if (recordsList) {
        recordsList.innerHTML = '';
        if (records.length === 0) {
            recordsList.innerHTML = '<li class="empty-state">Îì±Î°ùÎêú ÎåÄÌöå Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</li>';
        } else {
            records.forEach(rec => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="rec-meta"><span class="rec-event">${rec.event}</span><span class="rec-name">${rec.name} (${rec.date})</span></div><span class="rec-time">${rec.time}</span>`;
                recordsList.appendChild(li);
            });
        }
    }
    if (prDisplay && records.length > 0) {
        const recent = records[0];
        prDisplay.textContent = `${recent.event}: ${recent.time}`;
    } else if (prDisplay) {
        prDisplay.textContent = 'None';
    }
}

if (compForm) {
    compForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('comp-name').value;
        const date = document.getElementById('comp-date').value;
        const event = document.getElementById('comp-event').value;
        const time = document.getElementById('comp-time').value;
        const newRecord = { id: Date.now(), name, date, event, time };
        const records = JSON.parse(localStorage.getItem(RECORDS_KEY)) || [];
        records.push(newRecord);
        localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
        loadRecords();
        alert('Í∏∞Î°ùÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
        compForm.reset();
    });
}

// --- Analysis Feature ---
function initAnalysisControls() {
    const oldZone = document.getElementById('upload-zone');
    if (oldZone) {
        const fileInput = document.getElementById('video-upload');
        if (!fileInput) return;
        // Prevent duplicate listeners
        const newZone = oldZone.cloneNode(true);
        oldZone.parentNode.replaceChild(newZone, oldZone);
        
        const freshZone = document.getElementById('upload-zone');
        freshZone.addEventListener('click', () => fileInput.click());
        fileInput.onchange = (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); };
    }
}

function handleFile(file) {
    // Simulate Analysis
    const loader = document.getElementById('analysis-loader');
    const res = document.getElementById('analysis-results');
    const zone = document.getElementById('upload-zone');
    
    if(zone) zone.classList.add('hidden');
    if(res) res.classList.remove('hidden');
    if(loader) loader.classList.remove('hidden');
    
    setTimeout(() => {
        if(loader) loader.classList.add('hidden');
        // Show mock results...
        const totalTime = document.getElementById('res-total-time');
        if(totalTime) totalTime.textContent = "32.45s";
    }, 2000);
}

// --- Club Feature ---
const DEFAULT_CLUBS = [
    { id: 'seoul_dolphins', name: 'ÏÑúÏö∏ ÎèåÌïÄÏä§', desc: 'ÏÑúÏö∏ ÏßÄÏó≠ ÏßÅÏû•Ïù∏ ÏàòÏòÅ Î™®ÏûÑ', icon: 'üê¨', type: 'public' },
    { id: 'busan_marine', name: 'Î∂ÄÏÇ∞ ÎßàÎ¶∞Î≥¥Ïù¥', desc: 'Ìï¥Ïö¥ÎåÄ Î∞îÎã§ÏàòÏòÅ & Ïã§ÎÇ¥ÏàòÏòÅ', icon: 'üåä', type: 'public' }
];

function getClubs() {
    const customClubs = JSON.parse(localStorage.getItem(CUSTOM_CLUBS_KEY)) || [];
    return [...DEFAULT_CLUBS, ...customClubs];
}

function initClubFeature() {
    const savedClubId = localStorage.getItem(CLUB_KEY);
    if (savedClubId) showClubDashboard(savedClubId);
    else showClubSelection();
}

function showClubSelection() {
    const selectionView = document.getElementById('club-selection-view');
    const dashboardView = document.getElementById('club-dashboard-view');
    const clubList = document.getElementById('club-list');
    if(!selectionView || !dashboardView || !clubList) return;

    selectionView.classList.remove('hidden');
    dashboardView.classList.add('hidden');
    
    const allClubs = getClubs();
    clubList.innerHTML = allClubs.map(club => `
        <div class="club-card" onclick="joinClub('${club.id}')">
            <div class="club-icon">${club.icon}</div>
            <div class="club-details">
                <h3>${club.name} ${club.type==='private'?'üîí':''}</h3>
                <p>${club.desc}</p>
            </div>
        </div>
    `).join('');
}

window.joinClub = function(clubId) {
    const allClubs = getClubs();
    const club = allClubs.find(c => c.id === clubId);
    if(!club) return;
    
    if(confirm(`${club.name}Ïóê Í∞ÄÏûÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        localStorage.setItem(CLUB_KEY, clubId);
        showClubDashboard(clubId);
    }
};

window.leaveClub = function() {
    if(confirm('ÌÉàÌá¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        localStorage.removeItem(CLUB_KEY);
        showClubSelection();
    }
};

function showClubDashboard(clubId) {
    const selectionView = document.getElementById('club-selection-view');
    const dashboardView = document.getElementById('club-dashboard-view');
    const allClubs = getClubs();
    const club = allClubs.find(c => c.id === clubId);
    
    if (!club) { localStorage.removeItem(CLUB_KEY); showClubSelection(); return; }

    selectionView.classList.add('hidden');
    dashboardView.classList.remove('hidden');

    document.getElementById('my-club-name').textContent = club.name;
    document.getElementById('my-club-desc').textContent = club.desc;
    document.getElementById('my-club-icon').textContent = club.icon;
}

window.openCreateClubModal = () => document.getElementById('create-club-modal').classList.remove('hidden');
window.closeCreateClubModal = () => document.getElementById('create-club-modal').classList.add('hidden');

const createClubForm = document.getElementById('create-club-form');
if(createClubForm) {
    createClubForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('new-club-name').value;
        const desc = document.getElementById('new-club-desc').value;
        const icon = document.getElementById('new-club-icon').value;
        const type = document.getElementById('new-club-type').value;
        
        const newClub = { id: 'custom_' + Date.now(), name, desc, icon, type };
        const customClubs = JSON.parse(localStorage.getItem(CUSTOM_CLUBS_KEY)) || [];
        customClubs.push(newClub);
        localStorage.setItem(CUSTOM_CLUBS_KEY, JSON.stringify(customClubs));

        alert('ÌÅ¥ÎüΩÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
        closeCreateClubModal();
        joinClub(newClub.id); 
    });
}

// Modal Logic for Plan Details
window.openWorkoutModal = () => {
    const modal = document.getElementById('workout-modal');
    if (!modal || !currentDailyPlan) return;
    
    // Set Title
    const titleEl = document.getElementById('modal-title');
    if(titleEl) titleEl.textContent = currentDailyPlan.title;
    
    // Set Body
    const bodyEl = document.getElementById('modal-body');
    if(bodyEl) {
        let html = '';
        const sections = [
            {key:'warmup', title:'üî• Warm Up'},
            {key:'drill', title:'üõ†Ô∏è Drill'},
            {key:'main', title:'üèä Main Set'},
            {key:'cooldown', title:'‚ùÑÔ∏è Cool Down'}
        ];
        
        sections.forEach(sec => {
            if(currentDailyPlan[sec.key] && currentDailyPlan[sec.key].length > 0) {
                html += `<div class="workout-section" style="margin-bottom:1rem;">
                            <h4 style="margin-bottom:0.5rem; color:#2c5282;">${sec.title}</h4>`;
                currentDailyPlan[sec.key].forEach(set => {
                    html += `<div class="workout-item" style="display:flex; justify-content:space-between; padding:0.5rem; background:#f7fafc; margin-bottom:0.3rem; border-radius:4px;">
                                <span style="font-weight:700; color:#2b6cb0;">${set.dist}</span>
                                <span>${set.desc}</span>
                             </div>`;
                });
                html += `</div>`;
            }
        });
        bodyEl.innerHTML = html;
    }
    
    modal.classList.remove('hidden');
};

window.closeWorkoutModal = () => {
    const modal = document.getElementById('workout-modal');
    if(modal) modal.classList.add('hidden');
};

// Attach listener to card
document.addEventListener('DOMContentLoaded', () => {
    const planCard = document.querySelector('.main-plan-card');
    if(planCard) {
        planCard.addEventListener('click', (e) => {
            // Prevent if clicking the Terminology link specifically
            if(e.target.dataset.i18n === 'termHint') return; 
            if(e.target.classList.contains('tap-hint') && e.target.onclick) return;
            openWorkoutModal();
        });
    }
});